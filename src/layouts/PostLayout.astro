---
interface Frontmatter {
  title?: string;
  description?: string;
  pubDate?: string | Date;
  tags?: string[];
}

import '../styles/global.css';
import Nav from '../components/Nav.astro';
import Footer from '../components/Footer.astro';
import { slugify } from '../lib/slug';

const fm = Astro.props as Frontmatter;
const d = fm.pubDate ? new Date(fm.pubDate) : undefined;
const desc = fm.description ?? 'Bài viết blog về Java/JavaScript và lập trình mạng.';
const tags = fm.tags ?? [];

const basePath = Astro.site ? new URL(Astro.site).pathname.replace(/\/$/, '') + '/' : '/';

// Fallback tiêu đề từ slug nếu thiếu frontmatter.title
function toTitleFromSlug(slug: string) {
  const s = decodeURIComponent(slug.replace(/-/g, ' ').trim());
  return s ? s.replace(/\b\w/g, (m) => m.toUpperCase()) : 'Bài viết';
}
const path = Astro.url?.pathname?.replace(/\/$/, '') ?? '';
const lastSeg = path.split('/').pop() ?? '';
const autoTitle = toTitleFromSlug(lastSeg);
const displayTitle = (typeof fm.title === 'string' && fm.title.trim().length > 0) ? fm.title : autoTitle;

const pageTitle = `${displayTitle} • Lê Nguyễn Duy Khang`;

// Định dạng ngày giờ vi-VN (chỉ hiển thị giờ nếu có)
let metaDate = '';
if (d) {
  const dateStr = d.toLocaleDateString('vi-VN');
  const hh = d.getHours();
  const mm = d.getMinutes();
  if ((hh || mm) && !Number.isNaN(hh) && !Number.isNaN(mm)) {
    const timeStr = d.toLocaleTimeString('vi-VN', { hour: '2-digit', minute: '2-digit' });
    metaDate = `${dateStr} lúc ${timeStr}`;
  } else {
    metaDate = dateStr;
  }
}
---
<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>{pageTitle}</title>
    <meta name="description" content={desc} />
    <meta name="keywords" content={(tags.join(', ') + ', lập trình Java, JavaScript')} />
    <meta property="og:type" content="article" />
    <meta property="og:title" content={pageTitle} />
    <meta property="og:description" content={desc} />
    <meta property="og:image" content={`${basePath}images/avatar.jpg`} />
    <link rel="icon" href={`${basePath}images/js.svg`} />
  </head>
  <body>
    <Nav />
    <div class="container section post">
      <header class="post-hero card">
        <h1 class="post-title">{displayTitle}</h1>

        {tags.length > 0 && (
          <div class="chips" role="list">
            {tags.map((t) => (
              <a role="listitem" class="chip" href={`${basePath}tags/${slugify(t)}`} aria-label={`Tag: ${t}`}>{t}</a>
            ))}
          </div>
        )}

        {metaDate && (
          <div class="post-date" aria-label="Ngày đăng">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" aria-hidden="true" focusable="false">
              <path d="M7 2v3M17 2v3M3 10h18M4 6h16a1 1 0 0 1 1 1v12a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1V7a1 1 0 0 1 1-1Z" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            {metaDate}
          </div>
        )}
      </header>

      <article class="content">
        <slot />
      </article>

      <section aria-label="Bình luận" style="margin-top:28px">
        <div class="card">
          <strong>Bình luận</strong>
          <p style="color:var(--muted); margin:.4rem 0 0">
            Tính năng bình luận sẽ sớm được kích hoạt. Hãy quay lại sau nhé!
          </p>
        </div>
      </section>
    </div>
    <Footer />
  </body>
</html>

