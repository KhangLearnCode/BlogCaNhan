---
import BaseLayout from '../../../layouts/BaseLayout.astro';
import Nav from '../../../components/Nav.astro';
import Footer from '../../../components/Footer.astro';
import PostCard from '../../../components/PostCard.astro';

// BẮT BUỘC: tạo danh sách đường dẫn tĩnh cho các trang phân trang
export async function getStaticPaths() {
  // Định nghĩa số bài mỗi trang NGAY TRONG HÀM để tránh lỗi scope
  const PAGE_SIZE = 9;

  const all = await Astro.glob('../*.md');
  // Sắp xếp mới nhất trước
  all.sort(
    (a, b) =>
      new Date(b.frontmatter.pubDate || 0).getTime() -
      new Date(a.frontmatter.pubDate || 0).getTime()
  );

  const pageCount = Math.max(1, Math.ceil(all.length / PAGE_SIZE));
  return Array.from({ length: pageCount }, (_, i) => ({
    params: { page: String(i + 1) },
  }));
}

// Dữ liệu cho trang hiện tại (định nghĩa lại để rõ ràng, không phụ thuộc biến ngoài)
const PAGE_SIZE = 9;
const page = Number(Astro.params.page || 1);

const all = await Astro.glob('../*.md');
all.sort(
  (a, b) =>
    new Date(b.frontmatter.pubDate || 0).getTime() -
    new Date(a.frontmatter.pubDate || 0).getTime()
);
const pageCount = Math.max(1, Math.ceil(all.length / PAGE_SIZE));
const start = (page - 1) * PAGE_SIZE;
const posts = all.slice(start, start + PAGE_SIZE);

// Base path cho link (GitHub Pages dưới subpath)
const basePath = Astro.site ? new URL(Astro.site).pathname.replace(/\/$/, '') : '';
---
<BaseLayout title={`Blog – Trang ${page}`} description="Phân trang danh sách bài viết.">
  <Nav />
  <main class="container section">
    <h1 style="margin:0 0 12px">Blog – Trang {page}</h1>
    <div class="grid">
      {posts.map((p) => (
        <PostCard
          url={p.url}
          title={p.frontmatter.title}
          description={p.frontmatter.description}
          pubDate={p.frontmatter.pubDate}
          tags={p.frontmatter.tags}
        />
      ))}
    </div>

    <div style="display:flex; gap:10px; margin-top:16px">
      {page > 1 && <a class="btn" href={`${basePath}/blog/page/${page - 1}`}>← Trang trước</a>}
      <span class="badge">Trang {page}/{pageCount}</span>
      {page < pageCount && <a class="btn" href={`${basePath}/blog/page/${page + 1}`}>Trang sau →</a>}
    </div>

    <div style="margin-top:12px"><a class="badge" href={`${basePath}/blog`}>Về trang Blog</a></div>
  </main>
  <Footer />
</BaseLayout>
